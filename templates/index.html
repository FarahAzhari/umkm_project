<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Qwen Voice Assistant</title>
</head>
<body>
    <h2>🎙️ Qwen Voice Assistant</h2>
    <button id="btnSpeak">🎤 Mulai Bicara</button>
    <button id="btnStopSpeech">⏹️ Stop Qwen Bicara</button>

    <p><strong>Anda:</strong> <span id="userInput">-</span></p>
    <p><strong>Qwen:</strong> <span id="qwenResponse">-</span></p>

    <script>
        if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
            alert('Browser Anda tidak mendukung Web Speech API. Gunakan Chrome atau Edge.');
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();

        recognition.lang = 'id-ID';
        recognition.interimResults = true;
        recognition.continuous = true;
        recognition.maxAlternatives = 3;

        const btnSpeak = document.getElementById('btnSpeak');
        const btnStopSpeech = document.getElementById('btnStopSpeech');
        const userInput = document.getElementById('userInput');
        const qwenResponse = document.getElementById('qwenResponse');

        let listening = false;
        let finalTranscript = '';
        let silenceTimer = null;
        let userCancelled = false;

        btnSpeak.onclick = () => {
            if (!listening) {
                recognition.start();
                listening = true;
                userCancelled = false;
                finalTranscript = '';
                btnSpeak.textContent = '⏹️ Berhenti Mendengarkan';
                userInput.textContent = "🎤 Sedang mendengarkan... Silakan bicara";
                qwenResponse.textContent = "-";
            } else {
                userCancelled = true;
                recognition.stop();
                listening = false;
                btnSpeak.textContent = '🎤 Mulai Bicara';
            }
        };

        btnStopSpeech.onclick = () => {
            window.speechSynthesis.cancel();
        };

        function speakResponse(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'id-ID';

            const voices = speechSynthesis.getVoices();
            const indoVoice = voices.find(v => v.lang.startsWith('id'));
            if (indoVoice) utterance.voice = indoVoice;

            speechSynthesis.speak(utterance);
        }

        function resetSilenceTimer() {
            if (silenceTimer) clearTimeout(silenceTimer);
            silenceTimer = setTimeout(() => {
                recognition.stop();
            }, 1500); // 1.5 seconds of silence = done
        }

        recognition.onresult = (event) => {
            let interimTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                const transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    finalTranscript += transcript;
                } else {
                    interimTranscript += transcript;
                }
            }

            const combined = finalTranscript + interimTranscript;
            userInput.textContent = combined + (interimTranscript ? ' ...' : '');
            resetSilenceTimer();
        };

        recognition.onerror = (event) => {
            console.error('Speech recognition error:', event.error);
            userInput.textContent = "❌ Error: " + event.error;
            listening = false;
            btnSpeak.textContent = '🎤 Mulai Bicara';
            finalTranscript = '';
        };

        recognition.onend = () => {
            if (userCancelled || !finalTranscript.trim()) {
                userInput.textContent = userCancelled
                    ? "❌ Dihentikan sebelum selesai."
                    : "❌ Tidak ada suara yang tertangkap.";
                listening = false;
                btnSpeak.textContent = '🎤 Mulai Bicara';
                finalTranscript = '';
                return;
            }

            fetch(`/listen?text=${encodeURIComponent(finalTranscript.trim())}`)
                .then(res => res.json())
                .then(data => {
                    qwenResponse.textContent = data.response;
                    speakResponse(data.response);
                })
                .catch(err => {
                    qwenResponse.textContent = "❌ Gagal mengambil respon dari server.";
                    console.error(err);
                });

            listening = false;
            btnSpeak.textContent = '🎤 Mulai Bicara';
            finalTranscript = '';
        };
    </script>
</body>
</html>
